{
    "assignee": null,
    "body": "Dude, here is a bug.\r\n\r\nOn host lost connection i will never fire onClose event, cuz it is always at \"Stanza 4\", always if(strlen($header) == 0) (justed tested by turned off wi-fi adapter on my notebook), and shity that this is only one method (readStanza) wich cud check socket status at all. So by now, if connection is lost, i will never know about it somehow and will never get fireClose event. \r\n```\r\npublic function readStanza()\r\n    {\r\n        echo \"Start stanza\\n\";\r\n        $buff = '';\r\n        if($this->socket != null)\r\n        {\r\n            echo \"Stanza 1\\n\";\r\n            $header = @fread($this->socket, 3);//read stanza header\r\n            if(strlen($header) == 0)\r\n            {\r\n                echo \"Stanza 4\\n\";\r\n                //no data received\r\n                return;\r\n            }\r\n            if(strlen($header) != 3)\r\n            {\r\n                echo \"Stanza 5\\n\";\r\n                throw new Exception(\"Failed to read stanza header\");\r\n            }\r\n            $treeLength = 0;\r\n            $treeLength = ord($header[1]) << 8;\r\n            $treeLength |= ord($header[2]) << 0;\r\n\r\n            //read full length\r\n            $buff = @fread($this->socket, $treeLength);\r\n            $trlen = $treeLength;\r\n            $len = strlen($buff);\r\n            $prev = 0;\r\n            while(strlen($buff) < $treeLength)\r\n            {\r\n                $toRead = $treeLength - strlen($buff);\r\n                $buff .= @fread($this->socket, $toRead);\r\n                if($len == strlen($buff))\r\n                {\r\n                    //no new data read, fuck it\r\n                    break;\r\n                }\r\n                $len = strlen($buff);\r\n            }\r\n\r\n            if (strlen($buff) != $treeLength) {\r\n                echo \"Stanza 6\\n\";\r\n                throw new Exception(\"Tree length did not match received length (buff = \" . strlen($buff) . \" & treeLength = $treeLength)\");\r\n            } else\r\n            if (@feof($this->socket)) {\r\n                echo \"Stanza 7\\n\";\r\n                $error = \"socket EOF, closing socket...\";\r\n                fclose($this->socket);\r\n                $this->socket = null;\r\n                $this->eventManager()->fireClose(\r\n                    $this->phoneNumber,\r\n                    $error\r\n                );\r\n            }\r\n            $buff = $header . $buff;\r\n        }\r\n        else\r\n        {\r\n            echo \"Stanza 2\\n\";\r\n            throw new Exception(\"Socket closed\");\r\n        }\r\n        echo \"Stanza 3\\n\";\r\n        return $buff;\r\n    }\r\n```\r\n\r\nU must check feof every time at first, after if($this->socket != null){, and only then do stuff. Like:\r\n\r\n```\r\npublic function readStanza()\r\n    {\r\n        echo \"Start stanza\\n\";\r\n        $buff = '';\r\n        if($this->socket != null)\r\n        {\r\n            if (@feof($this->socket)) {\r\n                $error = \"socket EOF, closing socket...\";\r\n                fclose($this->socket);\r\n                $this->socket = null;\r\n                $this->eventManager()->fireClose(\r\n                    $this->phoneNumber,\r\n                    $error\r\n                );\r\n\r\n               return; // <- of course!!!\r\n            }\r\n            $header = @fread($this->socket, 3);//read stanza header\r\n```\r\n\r\nby the way, your write functions don't give any connecton information too. Every write data session i cud know, if the connection closed. Why there is no returns? Like:\r\n\r\n```\r\nfunction sendPresence(){\r\n...\r\n\treturn $this->sendNode(..);\r\n}\r\n\r\nfunction sendNode(){\r\n...\r\n\treturn $this->sendData(..);\r\n}\r\n\r\nfunction sendData(){\r\n...\r\n\tif( !( $flag = @fwrite(..)){\r\n                $error = \"socket EOF, closing socket...\";\r\n                fclose($this->socket);\r\n                $this->socket = null;\r\n                $this->eventManager()->fireClose(\r\n                    $this->phoneNumber,\r\n                    $error\r\n                );\r\n        }\r\n        return $flag;\t\t\r\n}\r\n```\r\nby ping server every 30 sec with sendPresence i cud know if the connection closed already, or u cud fireClose there too. Writing to socket every time is natural socket-check ability, wich is ignored at your code. Can u fix all of it? Thanks!\r\n\r\nAwsome api, awsome arch. I'm very skilled at php programming, and can help if u want",
    "closed_at": null,
    "comment_data": [
        {
            "body": "+1 for this",
            "created_at": "2014-09-20T23:12:03Z",
            "html_url": "https://github.com/venomous0x/WhatsAPI/issues/968#issuecomment-56283244",
            "id": 56283244,
            "issue_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/968",
            "updated_at": "2014-09-20T23:12:03Z",
            "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/comments/56283244",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5390491?v=3",
                "events_url": "https://api.github.com/users/dennobaby/events{/privacy}",
                "followers_url": "https://api.github.com/users/dennobaby/followers",
                "following_url": "https://api.github.com/users/dennobaby/following{/other_user}",
                "gists_url": "https://api.github.com/users/dennobaby/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dennobaby",
                "id": 5390491,
                "login": "dennobaby",
                "organizations_url": "https://api.github.com/users/dennobaby/orgs",
                "received_events_url": "https://api.github.com/users/dennobaby/received_events",
                "repos_url": "https://api.github.com/users/dennobaby/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dennobaby/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dennobaby/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dennobaby"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/968/comments",
    "created_at": "2014-09-20T17:25:04Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/968/events",
    "html_url": "https://github.com/venomous0x/WhatsAPI/issues/968",
    "id": 43315095,
    "labels": [],
    "labels_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/968/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 968,
    "state": "open",
    "title": "BUG: Connection close, fireClose event, work with sockets",
    "updated_at": "2014-09-20T23:12:03Z",
    "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/968",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3662288?v=3",
        "events_url": "https://api.github.com/users/m-derevyanko/events{/privacy}",
        "followers_url": "https://api.github.com/users/m-derevyanko/followers",
        "following_url": "https://api.github.com/users/m-derevyanko/following{/other_user}",
        "gists_url": "https://api.github.com/users/m-derevyanko/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/m-derevyanko",
        "id": 3662288,
        "login": "m-derevyanko",
        "organizations_url": "https://api.github.com/users/m-derevyanko/orgs",
        "received_events_url": "https://api.github.com/users/m-derevyanko/received_events",
        "repos_url": "https://api.github.com/users/m-derevyanko/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/m-derevyanko/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/m-derevyanko/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/m-derevyanko"
    }
}