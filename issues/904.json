{
    "assignee": null,
    "body": "Hi! I have implemented a php backend script that would respond to whatsapp client incoming messages. It works most of the time with client's messages sent to my backend with double ticks. \r\n\r\nHowever, sometimes client's messages are sent with only a single tick, not going to double ticks for a period of time, while my backend server is online. After that period of time, like twenty minutes, the single tick messages are all at a sudden received by my backend server...\r\n\r\nI tried, during that period, sending messages from my backend to the whatsapp client, they managed to reach the whatsapp client successfully. So I wonder what is the problem that caused my backend not being able to fetch the single-tick messages from whatsapp server while the connection should be fine?\r\n\r\nMany thanks!",
    "closed_at": null,
    "comment_data": [
        {
            "body": "I am using Laravel, and I used cron job (Dispatcher) to keep the whatsapp connection open. Here is the code that I implemented:\r\n\r\n\tpublic function fire()\r\n\t{\r\n\r\n\t\t// set command to run for a limited period\r\n\t\tset_time_limit(($this->online_minutes * 60 + 20));\r\n\t\t\r\n\t\t// set new time to cache\r\n\t\t$expiresAt = Carbon::now()->addMinutes($this->online_minutes + 10);\r\n\t\t$current_fire_time = time();\r\n\t\tLog::debug('WhatsappCommand start. current_fire_time['. date(\"Y-m-d h:i:s\",$current_fire_time).']');\r\n\t\tCache::tags('whatsapp')->put('new_fire_time', $current_fire_time, $expiresAt);\r\n\t\t\r\n\t\t// resolve singleton Whatsapp object which is connected and logged in\r\n\t\t$whatsapp = App::make('whatsapp');\r\n\r\n\t\t// register event listener\r\n\t\t$listener = new DoulaEasyWhatsAppListener();\r\n\t\t$whatsapp->eventManager()->addEventListener($listener);\r\n\r\n\t\t// ************** while loop START **************\r\n\t\t$loop_counter = 0;\r\n\t\twhile ($this->shouldRun($current_fire_time)) {\r\n\r\n\t\t\t// poll any real-time incoming messages\r\n\t\t\t// and let event manager handles them\r\n\t\t    $whatsapp->pollMessages();\r\n            echo '.';\r\n\r\n\t\t    // send active status every thirty loops\r\n\t\t    if ($loop_counter > 10) {\r\n\t\t    \t$whatsapp->sendActiveStatus();\r\n\t\t    \t$loop_counter = 0;\r\n\t\t    }\r\n\r\n\t\t\t// check again if timestamp has been updated\r\n\t\t    $this->shouldRun($current_fire_time); \r\n\r\n\t\t    // check for outbound messages to send:\r\n\t\t\t    // check in Redis queue for any outgoing messages\r\n\t\t\t    while (LRedis::llen('whatsapp_outgoing_message') > 0) {\r\n\t\t\t    \t$outgoing_message = json_decode(LRedis::lpop('whatsapp_outgoing_message'));\r\n\r\n\t\t\t\t\t// send the message\r\n\t\t    \t\t$whatsapp->pollMessages();\r\n\t\t\t\t\t$whatsapp->sendMessage($outgoing_message->target, $outgoing_message->message);\r\n\t\t\t    }\r\n\r\n\t\t    // delay next execution for some time\r\n\t\t\tsleep(2);\r\n\r\n\t\t\t$loop_counter++;\r\n\t\t}\r\n\t\t// ************** while loop END **************\r\n\t}\r\n\r\n\r\n\tprivate function shouldRun($current_fire_time) {\r\n\r\n\t    $new_fire_time = Cache::tags('whatsapp')->get('new_fire_time');\r\n\r\n\t    if ($current_fire_time != $new_fire_time) {\r\n\t\t\tLog::debug('WhatsappCommand die. current_fire_time['. date(\"Y-m-d h:i:s\",$current_fire_time).'] '.\r\n\t\t\t\t\t\t 'new_fire_time['. date(\"Y-m-d h:i:s\",$new_fire_time).']');\r\n\t        die();\r\n\t    }\r\n\t    return true; //continue running\r\n\t}",
            "created_at": "2014-08-22T17:53:14Z",
            "html_url": "https://github.com/venomous0x/WhatsAPI/issues/904#issuecomment-53096814",
            "id": 53096814,
            "issue_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904",
            "updated_at": "2014-08-22T17:53:14Z",
            "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/comments/53096814",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1496881?v=3",
                "events_url": "https://api.github.com/users/isaacqc/events{/privacy}",
                "followers_url": "https://api.github.com/users/isaacqc/followers",
                "following_url": "https://api.github.com/users/isaacqc/following{/other_user}",
                "gists_url": "https://api.github.com/users/isaacqc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/isaacqc",
                "id": 1496881,
                "login": "isaacqc",
                "organizations_url": "https://api.github.com/users/isaacqc/orgs",
                "received_events_url": "https://api.github.com/users/isaacqc/received_events",
                "repos_url": "https://api.github.com/users/isaacqc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/isaacqc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/isaacqc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/isaacqc"
            }
        },
        {
            "body": "I found that if I pollMessages right after loginWithPassword and before doing any other actions, the occurrence of the problem is greatly reduced",
            "created_at": "2014-08-25T08:04:17Z",
            "html_url": "https://github.com/venomous0x/WhatsAPI/issues/904#issuecomment-53237704",
            "id": 53237704,
            "issue_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904",
            "updated_at": "2014-08-25T08:04:17Z",
            "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/comments/53237704",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1496881?v=3",
                "events_url": "https://api.github.com/users/isaacqc/events{/privacy}",
                "followers_url": "https://api.github.com/users/isaacqc/followers",
                "following_url": "https://api.github.com/users/isaacqc/following{/other_user}",
                "gists_url": "https://api.github.com/users/isaacqc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/isaacqc",
                "id": 1496881,
                "login": "isaacqc",
                "organizations_url": "https://api.github.com/users/isaacqc/orgs",
                "received_events_url": "https://api.github.com/users/isaacqc/received_events",
                "repos_url": "https://api.github.com/users/isaacqc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/isaacqc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/isaacqc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/isaacqc"
            }
        },
        {
            "body": "Update whatsprot.class , and you dont need to put pollMessage right after loginWithPassword",
            "created_at": "2014-08-25T09:09:36Z",
            "html_url": "https://github.com/venomous0x/WhatsAPI/issues/904#issuecomment-53242802",
            "id": 53242802,
            "issue_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904",
            "updated_at": "2014-08-25T09:09:36Z",
            "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/comments/53242802",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5390120?v=3",
                "events_url": "https://api.github.com/users/mgp25/events{/privacy}",
                "followers_url": "https://api.github.com/users/mgp25/followers",
                "following_url": "https://api.github.com/users/mgp25/following{/other_user}",
                "gists_url": "https://api.github.com/users/mgp25/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mgp25",
                "id": 5390120,
                "login": "mgp25",
                "organizations_url": "https://api.github.com/users/mgp25/orgs",
                "received_events_url": "https://api.github.com/users/mgp25/received_events",
                "repos_url": "https://api.github.com/users/mgp25/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mgp25/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mgp25/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mgp25"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904/comments",
    "created_at": "2014-08-22T17:44:42Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904/events",
    "html_url": "https://github.com/venomous0x/WhatsAPI/issues/904",
    "id": 40931995,
    "labels": [],
    "labels_url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 904,
    "state": "open",
    "title": "receive message problem: occasional single tick",
    "updated_at": "2014-08-25T09:09:36Z",
    "url": "https://api.github.com/repos/venomous0x/WhatsAPI/issues/904",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1496881?v=3",
        "events_url": "https://api.github.com/users/isaacqc/events{/privacy}",
        "followers_url": "https://api.github.com/users/isaacqc/followers",
        "following_url": "https://api.github.com/users/isaacqc/following{/other_user}",
        "gists_url": "https://api.github.com/users/isaacqc/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/isaacqc",
        "id": 1496881,
        "login": "isaacqc",
        "organizations_url": "https://api.github.com/users/isaacqc/orgs",
        "received_events_url": "https://api.github.com/users/isaacqc/received_events",
        "repos_url": "https://api.github.com/users/isaacqc/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/isaacqc/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/isaacqc/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/isaacqc"
    }
}